apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init
  namespace: paystream
  labels:
    app.kubernetes.io/name: vault-init
    app.kubernetes.io/component: secrets-management
    app.kubernetes.io/part-of: paystream
spec:
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: vault-init
          image: hashicorp/vault:1.15
          env:
            - name: VAULT_ADDR
              value: "http://vault:8200"
            - name: VAULT_TOKEN
              value: "root"
          command:
            - /bin/sh
            - -c
            - |
              # Wait for Vault to be ready
              until vault status 2>/dev/null; do
                echo "Waiting for Vault..."
                sleep 2
              done

              echo "Enabling KV secrets engine..."
              vault secrets enable -path=paystream kv-v2 2>/dev/null || true

              echo "Seeding production secrets..."
              vault kv put paystream/prod/auth-service \
                bank-api-key="sk_live_4eC39HqLyjWDarjtT1zdp7dc_visa_prod_2026" \
                db-password="Pr0d!DB#Str0ng$Pass2026_paystream" \
                encryption-key="aes256-prod-k3y-f8a2b1c4d5e6f7g8h9i0j1k2l3m4n5o6"

              echo "Seeding staging secrets..."
              vault kv put paystream/staging/auth-service \
                bank-api-key="sk_test_staging_7fB92KmNzXeQrsuV3wYp8ac" \
                db-password="Stg!DB#T3st$Pass2026_paystream" \
                encryption-key="aes256-stg-k3y-a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"

              echo "Verifying secrets..."
              vault kv get paystream/prod/auth-service
              vault kv get paystream/staging/auth-service
              echo "Vault initialization complete!"
